<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="payme.css">
    <title>Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…ÙˆØ§Ù„</title>
</head>
<body>
    <div class="send-container">
        <h2>Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…ÙˆØ§Ù„</h2>
        
        <div class="send-form">
            <div class="input-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©:</label>
                <select class="currency-select" id="sendCurrency">
                    <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                    <option value="IRR">Ø±ÙŠØ§Ù„ Ø¥ÙŠØ±Ø§Ù†ÙŠ (ï·¼)</option>
                    <option value="USDT">ØªØ«Ø± (T)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø³Ø§Ù„Ù‡:</label>
                <input type="number" class="amount-input" id="sendAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
                <small class="balance-info">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: <span id="sendBalance">0</span></small>
            </div>
            
            <div class="input-group">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                <input type="text" class="address-input" id="recipientAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨">
            </div>
            
            <div class="input-group">
                <label>Ø±Ø³Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <textarea class="message-input" id="sendMessage" placeholder="Ø£Ø¶Ù Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªÙ„Ù…"></textarea>
            </div>
            
            <div class="send-summary">
                <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù„: <span id="sendSummaryAmount">0</span> <span id="sendSummaryCurrency">$</span></p>
                <p>Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©: <span id="networkFee">0.5</span> <span id="networkFeeCurrency">$</span></p>
                <p class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="sendTotalAmount">0</span> <span id="sendTotalCurrency">$</span></p>
            </div>
            
            <button class="send-submit-btn" id="sendSubmit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
            <button class="back-btn" onclick="window.location.href='wallet.html'">Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
        </div>
    </div>
    
    
        <!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ù€ script Ù‚Ø¨Ù„ </body> -->
    <script>
        const CURRENT_USER_ID = 1;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        async function loadBalance() {
            try {
                const response = await fetch(`/api/balance/${CURRENT_USER_ID}`);
                const data = await response.json();
            
                if (data.success) {
                    document.getElementById('sendBalance').textContent = data.balances.USD + ' $';
                }
            } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯:', error);
            }
        }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„
        async function sendMoney() {
            const amount = parseFloat(document.getElementById('sendAmount').value);
                const currency = document.getElementById('sendCurrency').value;
            const recipientAddress = document.getElementById('recipientAddress').value;
        
            if (!amount || amount <= 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }
        
            if (!recipientAddress) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…');
                return;
            }

            try {
            // Ø£ÙˆÙ„Ø§Ù‹ ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù…Ù†Ø§
                const checkResponse = await fetch('/api/user/exists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: recipientAddress
                    })
                });
            
                const checkData = await checkResponse.json();
                    let toUserId = null;
            
                if (checkData.success) {
                    toUserId = checkData.user_id;
                }
            
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const response = await fetch('/api/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_user_id: CURRENT_USER_ID,
                        to_user_id: toUserId,
                            amount: amount,
                        currency: currency,
                        recipient_address: recipientAddress
                    })
                });

                const data = await response.json();
            
                if (data.success) {
                    alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
                window.location.href = 'wallet.html';
                } else {
                    alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + data.message);
                }
            } catch (error) {
                        console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message);
            }
        }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ
        function updateSummary() {
            const amount = parseFloat(document.getElementById('sendAmount').value) || 0;
            const currency = document.getElementById('sendCurrency').value;
        
            const fee = amount * 0.01; // Ø¹Ù…ÙˆÙ„Ø© 1%
            const total = amount + fee;
            document.getElementById('sendSummaryAmount').textContent = amount.toFixed(2);
            document.getElementById('sendSummaryCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('networkFee').textContent = fee.toFixed(2);
            document.getElementById('networkFeeCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('sendTotalAmount').textContent = total.toFixed(2);
            document.getElementById('sendTotalCurrency').textContent = getCurrencySymbol(currency);
        }

        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'IRR': 'ï·¼', 
                'USDT': 'T'
            };
            return symbols[currency] || currency;
        }

    // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        document.addEventListener('DOMContentLoaded', function() {
            loadBalance();
        
            document.getElementById('sendAmount').addEventListener('input', updateSummary);
                document.getElementById('sendCurrency').addEventListener('change', function() {
                loadBalance();
                updateSummary();
            });
        
            document.getElementById('sendSubmit').addEventListener('click', sendMoney);
        
        // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù…Ù„Ø®Øµ
            updateSummary();
        });
    </script>
    
    
</body>
</html>