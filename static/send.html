<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="payme.css">
    <title>إرسال أموال</title>
</head>
<body>
    <div class="send-container">
        <h2>إرسال أموال</h2>
        
        <div class="send-form">
            <div class="input-group">
                <label>اختر العملة:</label>
                <select class="currency-select" id="sendCurrency">
                    <option value="USD">دولار أمريكي ($)</option>
                    <option value="IRR">ريال إيراني (﷼)</option>
                    <option value="USDT">تثر (T)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>المبلغ المراد إرساله:</label>
                <input type="number" class="amount-input" id="sendAmount" placeholder="أدخل المبلغ">
                <small class="balance-info">الرصيد المتاح: <span id="sendBalance">0</span></small>
            </div>
            
            <div class="input-group">
                <label>عنوان المحفظة أو الحساب المستلم:</label>
                <input type="text" class="address-input" id="recipientAddress" placeholder="أدخل العنوان أو رقم الحساب">
            </div>
            
            <div class="input-group">
                <label>رسالة (اختياري):</label>
                <textarea class="message-input" id="sendMessage" placeholder="أضف رسالة للمستلم"></textarea>
            </div>
            
            <div class="send-summary">
                <p>المبلغ المرسل: <span id="sendSummaryAmount">0</span> <span id="sendSummaryCurrency">$</span></p>
                <p>عمولة الشبكة: <span id="networkFee">0.5</span> <span id="networkFeeCurrency">$</span></p>
                <p class="total">المبلغ الإجمالي: <span id="sendTotalAmount">0</span> <span id="sendTotalCurrency">$</span></p>
            </div>
            
            <button class="send-submit-btn" id="sendSubmit">تأكيد الإرسال</button>
            <button class="back-btn" onclick="window.location.href='wallet.html'">رجوع إلى المحفظة</button>
        </div>
    </div>
    
    
        <!-- أضف هذا الـ script قبل </body> -->
    <script>
        const CURRENT_USER_ID = 1;

    // جلب الرصيد عند تحميل الصفحة
        async function loadBalance() {
            try {
                const response = await fetch(`/api/balance/${CURRENT_USER_ID}`);
                const data = await response.json();
            
                if (data.success) {
                    document.getElementById('sendBalance').textContent = data.balances.USD + ' $';
                }
            } catch (error) {
                    console.error('خطأ في جلب الرصيد:', error);
            }
        }

    // إرسال الأموال
        async function sendMoney() {
            const amount = parseFloat(document.getElementById('sendAmount').value);
                const currency = document.getElementById('sendCurrency').value;
            const recipientAddress = document.getElementById('recipientAddress').value;
        
            if (!amount || amount <= 0) {
                alert('⚠️ يرجى إدخال مبلغ صحيح');
                return;
            }
        
            if (!recipientAddress) {
                alert('⚠️ يرجى إدخال عنوان المستلم');
                return;
            }

            try {
            // أولاً تحقق إذا كان المستخدم موجوداً في نظامنا
                const checkResponse = await fetch('/api/user/exists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: recipientAddress
                    })
                });
            
                const checkData = await checkResponse.json();
                    let toUserId = null;
            
                if (checkData.success) {
                    toUserId = checkData.user_id;
                }
            
            // تنفيذ الإرسال
                const response = await fetch('/api/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_user_id: CURRENT_USER_ID,
                        to_user_id: toUserId,
                            amount: amount,
                        currency: currency,
                        recipient_address: recipientAddress
                    })
                });

                const data = await response.json();
            
                if (data.success) {
                    alert('✅ تم الإرسال بنجاح!');
                window.location.href = 'wallet.html';
                } else {
                    alert('❌ فشل في الإرسال: ' + data.message);
                }
            } catch (error) {
                        console.error('💥 خطأ في الإرسال:', error);
                alert('❌ حدث خطأ أثناء الإرسال: ' + error.message);
            }
        }

    // تحديث الملخص
        function updateSummary() {
            const amount = parseFloat(document.getElementById('sendAmount').value) || 0;
            const currency = document.getElementById('sendCurrency').value;
        
            const fee = amount * 0.01; // عمولة 1%
            const total = amount + fee;
            document.getElementById('sendSummaryAmount').textContent = amount.toFixed(2);
            document.getElementById('sendSummaryCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('networkFee').textContent = fee.toFixed(2);
            document.getElementById('networkFeeCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('sendTotalAmount').textContent = total.toFixed(2);
            document.getElementById('sendTotalCurrency').textContent = getCurrencySymbol(currency);
        }

        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'IRR': '﷼', 
                'USDT': 'T'
            };
            return symbols[currency] || currency;
        }

    // استمع لتغييرات المدخلات
        document.addEventListener('DOMContentLoaded', function() {
            loadBalance();
        
            document.getElementById('sendAmount').addEventListener('input', updateSummary);
                document.getElementById('sendCurrency').addEventListener('change', function() {
                loadBalance();
                updateSummary();
            });
        
            document.getElementById('sendSubmit').addEventListener('click', sendMoney);
        
        // تحديث أولي للملخص
            updateSummary();
        });
    </script>
    
    
</body>
</html>