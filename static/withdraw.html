<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="payme.css">
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„</title>
</head>
<body>
    <div class="withdraw-container">
        <h2>Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</h2>
        
        <div class="withdraw-form">
            <div class="input-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©:</label>
                <select class="currency-select" id="withdrawCurrency">
                    <option value="IRR">Ø±ÙŠØ§Ù„ Ø¥ÙŠØ±Ø§Ù†ÙŠ (ï·¼)</option>
                    <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨Ù‡:</label>
                <input type="number" class="amount-input" id="withdrawAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
                <small class="balance-info">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: <span id="availableBalance">0</span></small>
            </div>
            
            <div class="input-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ©:</label>
                <input type="text" class="card-input" id="cardNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" maxlength="16">
            </div>
            
            <div class="bank-info">
                <h3>Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:</h3>
                <ul>
                    <li>ğŸ’³ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ÙˆØ·Ù†ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ù†ÙŠ</li>
                    <li>ğŸ’³ Ø¨Ù†Ùƒ Ù…Ù„ÙŠ Ø¥ÙŠØ±Ø§Ù†</li>
                    <li>ğŸ’³ Ø¨Ù†Ùƒ ØµØ§Ø¯Ø±Ø§Øª Ø¥ÙŠØ±Ø§Ù†</li>
                    <li>ğŸ’³ Ø¨Ù†Ùƒ ØªØ¬Ø§Ø±Øª</li>
                </ul>
            </div>
            
            <div class="withdraw-summary">
                <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨: <span id="summaryAmount">0</span> <span id="summaryCurrency">ï·¼</span></p>
                <p>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: <span id="fee">0</span> <span id="feeCurrency">ï·¼</span></p>
                <p class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalAmount">0</span> <span id="totalCurrency">ï·¼</span></p>
            </div>
            
            <button class="withdraw-submit-btn" id="withdrawSubmit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>
            <button class="back-btn" onclick="window.location.href='wallet.html'">Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
        </div>
    </div>
    
    
    <script>
        const CURRENT_USER_ID = 1;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­
        async function loadBalance() {
            try {
                const response = await fetch(`/api/balance/${CURRENT_USER_ID}`);
                const data = await response.json();
            
                if (data.success) {
                    const currency = document.getElementById('withdrawCurrency').value;
                    const balance = data.balances[currency] || 0;
                    document.getElementById('availableBalance').textContent = 
                        balance.toLocaleString() + getCurrencySymbol(currency);
                
                    updateSummary();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯:', error);
            }
        }

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø­Ø¨
        function updateSummary() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            const currency = document.getElementById('withdrawCurrency').value;
        
        // Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø³Ø­Ø¨ (1%)
            const fee = amount * 0.01;
            const total = amount + fee;
        
            document.getElementById('summaryAmount').textContent = amount.toLocaleString();
            document.getElementById('summaryCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('fee').textContent = fee.toLocaleString();
            document.getElementById('feeCurrency').textContent = getCurrencySymbol(currency);
            document.getElementById('totalAmount').textContent = total.toLocaleString();
            document.getElementById('totalCurrency').textContent = getCurrencySymbol(currency);
        }

    // Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'IRR': 'ï·¼', 
                'USDT': 'T'
            };
            return symbols[currency] || currency;
        }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        function validateCardNumber(cardNumber) {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… 16 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 6 (Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ù†ÙŠØ©)
            const regex = /^6[0-9]{15}$/;
            return regex.test(cardNumber.replace(/\s/g, ''));
        }

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø­Ø¨
        async function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const currency = document.getElementById('withdrawCurrency').value;
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!amount || amount <= 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }
        
            if (!validateCardNumber(cardNumber)) {
                alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16 Ø±Ù‚Ù…Ø§Ù‹ ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 6');
                return;
            }

            try {
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: CURRENT_USER_ID,
                        amount: amount,
                        currency: currency,
                        card_number: cardNumber
                    })
                });

                const data = await response.json();
            
                if (data.success) {
                    alert('âœ… ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.');
                    window.location.href = 'wallet.html';
                } else {
                    alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨: ' + data.message);
                }
            } catch (error) {
                console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨: ' + error.message);
            }
        }

    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
            let formattedValue = '';
        
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                }
                formattedValue += value[i];
            }
        
            input.value = formattedValue;
        }

    // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        document.addEventListener('DOMContentLoaded', function() {
            loadBalance();
        
            document.getElementById('withdrawAmount').addEventListener('input', updateSummary);
            document.getElementById('withdrawCurrency').addEventListener('change', loadBalance);
            document.getElementById('cardNumber').addEventListener('input', function() {
                formatCardNumber(this);
            });
        
            document.getElementById('withdrawSubmit').addEventListener('click', processWithdrawal);
        });
    </script>
    
    
</body>
</html>