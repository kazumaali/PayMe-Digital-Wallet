<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="payme.css">
    <title>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</title>
</head>
<body>
    <div class="exchange-container">
        <h2>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</h2>
        
        <div class="conversion-form">
            <div class="input-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡:</label>
                <input type="number" class="amount-input" id="amount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" min="0" value="100">
            </div>
            
            <div class="currency-selectors">
                <div class="input-group">
                    <label>Ù…Ù† Ø¹Ù…Ù„Ø©:</label>
                    <select class="currency-select" id="fromCurrency">
                        <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                        <option value="IRR">Ø±ÙŠØ§Ù„ Ø¥ÙŠØ±Ø§Ù†ÙŠ (ï·¼)</option>
                        <option value="USDT">ØªØ«Ø± (T)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Ø¥Ù„Ù‰ Ø¹Ù…Ù„Ø©:</label>
                    <select class="currency-select" id="toCurrency">
                        <option value="IRR">Ø±ÙŠØ§Ù„ Ø¥ÙŠØ±Ø§Ù†ÙŠ (ï·¼)</option>
                        <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                        <option value="USDT">ØªØ«Ø± (T)</option>
                    </select>
                </div>
            </div>
            
            <div class="conversion-result">
                <h3>Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„:</h3>
                <p>Ø³ÙˆÙ ØªØ­ØµÙ„ Ø¹Ù„Ù‰: <strong><span id="convertedAmount">0</span> <span id="resultCurrency">$</span></strong></p>
                <p>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: <span id="exchangeRate">1</span></p>
            </div>
            
            <button class="convert-btn" id="convertBtn">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
            <button class="back-btn" onclick="window.location.href='wallet.html'">Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
        </div>
    </div>

    <script>
        const CURRENT_USER_ID = 1;
        let currentRates = {};

        // Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù
        async function loadExchangeRates() {
            try {
                console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù...');
                const response = await fetch('/api/exchange-rate');
                const data = await response.json();
                console.log('ğŸ“Š Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:', data);
                
                if (data.success) {
                    currentRates = data.rates;
                    updateConversionPreview();
                } else {
                    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„
        function updateConversionPreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const fromCurrency = document.getElementById('fromCurrency').value;
            const toCurrency = document.getElementById('toCurrency').value;
            
            console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:', { amount, fromCurrency, toCurrency });
            
            if (amount > 0 && currentRates) {
                const rateKey = `${fromCurrency}_TO_${toCurrency}`;
                console.log('ğŸ”‘ Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø¹Ø±:', rateKey);
                console.log('ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:', Object.keys(currentRates));
                
                const rate = currentRates[rateKey];
                console.log('ğŸ“ˆ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', rate);
                
                if (rate) {
                    const converted = amount * rate;
                    
                    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø«Ù… Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©
                    document.getElementById('convertedAmount').textContent = converted.toFixed(6);
                    document.getElementById('resultCurrency').textContent = getCurrencySymbol(toCurrency);
                    document.getElementById('exchangeRate').textContent = rate.toFixed(6);
                } else {
                    document.getElementById('convertedAmount').textContent = '0';
                    document.getElementById('resultCurrency').textContent = getCurrencySymbol(toCurrency);
                    document.getElementById('exchangeRate').textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'IRR': 'ï·¼', 
                'USDT': 'T'
            };
            return symbols[currency] || currency;
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©
        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amount').value);
            const fromCurrency = document.getElementById('fromCurrency').value;
            const toCurrency = document.getElementById('toCurrency').value;
            
            console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„:', { amount, fromCurrency, toCurrency });
            
            if (!amount || amount <= 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }

            if (fromCurrency === toCurrency) {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…Ù„Ø©');
                return;
            }

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: CURRENT_USER_ID,
                        from_currency: fromCurrency,
                        to_currency: toCurrency,
                        amount: amount
                    })
                });

                console.log('ğŸ“¨ Response status:', response.status);
                const data = await response.json();
                console.log('ğŸ“Š Response data:', data);
                
                if (data.success) {
                    alert('âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    window.location.href = 'wallet.html';
                } else {
                    alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ' + (data.message || 'Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ' + error.message);
            }
        }

        // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ ØµÙØ­Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¬Ø§Ù‡Ø²Ø©');
            
            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            document.getElementById('amount').addEventListener('input', updateConversionPreview);
            document.getElementById('fromCurrency').addEventListener('change', updateConversionPreview);
            document.getElementById('toCurrency').addEventListener('change', updateConversionPreview);
            document.getElementById('convertBtn').addEventListener('click', convertCurrency);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            loadExchangeRates();
        });
    </script>
</body>
</html>